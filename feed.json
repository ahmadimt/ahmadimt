{
    "version": "https://jsonfeed.org/version/1",
    "title": "imteyazahmad.com",
    "description": "",
    "home_page_url": "https://imteyazahmad.com",
    "feed_url": "https://imteyazahmad.com/feed.json",
    "user_comment": "",
    "author": {
        "name": "Imteyaz Ahmad"
    },
    "items": [
        {
            "id": "https://imteyazahmad.com/elasticsearch-searching-using-java-high-level-rest-client/",
            "url": "https://imteyazahmad.com/elasticsearch-searching-using-java-high-level-rest-client/",
            "title": "Elasticsearch: Query using Java High Level Rest Client",
            "summary": " In the previous post we saw how to configure Elasticsearch Java&hellip;",
            "content_html": "\n  <p>\n    In the <a href=\"https://imteyazahmad.com/configuring-elasticsearch-java-high-level-rest-client-2/\">previous post</a> we saw how to configure Elasticsearch Java high level rest client. In this post we are going to discuss how to make search request using the same.\n  </p>\n\n    <h2 id=\"introduction\">\n      Introduction\n    </h2>\n\n  <p>\n    Once we have configured our Elasticsearch Java high level rest client, it won't be useful if we don't make it work. Here we are going to use it to make some queries and see the result. We will use some fake data here.\n  </p>\n\n    <h5 id=\"adding-data\">\n      Adding Data\n    </h5>\n\n  <p>\n    We can download data from <a href=\"https://github.com/elastic/elasticsearch/blob/master/docs/src/test/resources/accounts.json\" target=\"_blank\" rel=\"nofollow noopener\">Elasticsearch repository</a>. If you are using Linux the we can download the data as shown&nbsp; below:\n  </p>\n<pre class=\"line-numbers  language-java\"><code>wget https://github.com/elastic/elasticsearch/blob/master/docs/src/test/resources/accounts.json?raw=true -O accounts.json     \n</code></pre>\n\n  <p>\n    Once downloaded, run the below commands to insert data into Elasticsearch&nbsp;\n  </p>\n<pre class=\"line-numbers  language-bash\"><code># Create an index named \"accounts\"\ncurl XPUT http://localhost:9200/accounts\n# Bulk insert data into this index\ncurl -s -H \"Content-Type: application/x-ndjson\" -XPOST http://localhost:9200/accounts/_bulk --data-binary @accounts.json\n# once this is done we can verify the data\ncurl -XGET http://localhost:9200/accounts/_count\n#this should return something like this  \n{\"count\":1000,\"_shards\":{\"total\":1,\"successful\":1,\"skipped\":0,\"failed\":0}}\n</code></pre>\n\n    <h2 id=\"query-preparation\">\n      Query Preparation\n    </h2>\n\n  <p>\n    With the data in place we want to know the followings:\n  </p>\n\n  <ul>\n    <li>How many users have balance between 1000-2000?</li>\n  </ul>\n\n  <p>\n    First let's see the JSON query for the same:\n  </p>\n<pre class=\"line-numbers  language-json\"><code>POST accounts/_search\n{\"size\":10000,\"query\":{\"bool\":{\"filter\":[{\"range\":{\"balance\":{\"gte\":1000,\"lte\":2000}}}]}},\"sort\":[{\"balance\":{\"order\":\"desc\"}}]}</code></pre>\n\n  <p>\n    Now, we will create the same query using Elasticsearch high level rest client.\n  </p>\n<pre class=\"line-numbers  language-java\"><code>#First we need a bool query with a range filter\nfinal var boolQueryBuilder = QueryBuilders.boolQuery();\n    boolQueryBuilder\n        .filter(QueryBuilders.rangeQuery(\"balance\")\n                .gte(1000).lte(2000)\n                .includeLower(true)\n                .includeUpper(false));\n\n#After this we provide this to SearchSourceBuilder\nfinal var searchSourceBuilder = new SearchSourceBuilder();\nsearchSourceBuilder.size(1000);\nsearchSourceBuilder.query(boolQueryBuilder);\nsearchSourceBuilder.sort(\"balance\");\n\n#And pass this source  builder to search request\nfinal var searchRequest = new SearchRequest();\nsearchRequest.indices(\"accounts\");\nsearchRequest.source(searchSourceBuilder);\n\n</code></pre>\n\n  <p>\n    Once that's done, we need to use the <code>HighLevelRestClient</code> to call Elasticsearch\n  </p>\n<pre class=\"line-numbers  language-json\"><code>final ElasticsearchConfig elasticsearchConfig = new ElasticsearchConfig();\nfinal RestHighLevelClient restHighLevelClient = elasticsearchConfig.restHighLevelClient();\nfinal var searchResponse = restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);\n</code></pre>\n\n  <p>\n    After this we can parse the result as shown below:\n  </p>\n<pre class=\"line-numbers  language-java\"><code>final var hits = searchResponse.getHits().getHits();\nfinal var customers = Arrays.stream(hits)\n        .map(SearchHit::getSourceAsMap)\n        // Here we are mapping the data to string. you can also map to some object like Account\n        .map(stringObjectMap -&gt; \"Name: \" + stringObjectMap.get(\"firstname\") + \" \"\n            + stringObjectMap.get(\"lastname\") + \", Balance: \" + stringObjectMap.get(\"balance\"))\n        .collect(Collectors.toList());</code></pre>\n\n  <p>\n    A working code example is present in this <a href=\"https://github.com/ahmadimt/elasticsearch_samples/tree/main/query_high_level_rest_client\" target=\"_blank\">git repository</a>.\n  </p>\n\n    <h2 id=\"references\">\n      References\n    </h2>\n\n  <ul>\n    <li>https://github.com/elastic/elasticsearch/blob/master/docs/src/test/resources/accounts.json</li><li>https://pixabay.com/users/geralt-9301/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=1248053</li><li>https://qbox.io/blog/understanding-bulk-indexing-in-elasticsearch/<br></li><li>https://pixabay.com/illustrations/hand-magnifying-glass-earth-globe-1248053/<br></li>\n  </ul>\n\n  <p>\n    \n  </p>\n\n  <p>\n    \n  </p>\n\n  <p>\n    \n  </p>",
            "image": "https://imteyazahmad.com/media/posts/4/hand-1248053_1920.jpg",
            "author": {
                "name": "Imteyaz Ahmad"
            },
            "tags": [
            ],
            "date_published": "2021-04-07T10:03:32+05:30",
            "date_modified": "2021-04-07T16:50:19+05:30"
        },
        {
            "id": "https://imteyazahmad.com/configuring-elasticsearch-java-high-level-rest-client-2/",
            "url": "https://imteyazahmad.com/configuring-elasticsearch-java-high-level-rest-client-2/",
            "title": "Elasticsearch: Java High Level Rest Client",
            "summary": " This article describe how to configure the new Elasticsearch Java High&hellip;",
            "content_html": "\n  <p>\n    This article describe how to configure the new Elasticsearch Java High level rest client in a Java Application.\n  </p>\n\n    <h2 id=\"introduction\">\n      Introduction\n    </h2>\n\n  <p>\n    Elasticsearch&nbsp;5.0.0 released it first&nbsp;Java REST Client. This client was called low-level client as the Java users had to build the JSON request and parse the results. Later, Elasticsearch 5.6 introduced&nbsp;&nbsp;Java High Level REST Client which accepts&nbsp;request objects and returns response objects for the most important APIs(info, get, index, delete, update, bulk, search, search-scroll, and clear-scroll). For other APIs, we still have to use the low-level client.\n  </p>\n\n    <h2 id=\"dependencies\">\n      Dependencies\n    </h2>\n\n  <p>\n    It depends of the following artifacts and their transitive dependencies:<br>\n  </p>\n\n  <ul>\n    <li>org.elasticsearch.client:elasticsearch-rest-client</li><li>org.elasticsearch:elasticsearch<br></li>\n  </ul>\n\n  <p>\n    The minimum Java version required is <code>1.8</code>.&nbsp;\n  </p>\n\n  <p>\n    If you are using maven then it can declared as follows\n  </p>\n<pre class=\"line-numbers  language-java\"><code>&lt;dependency&gt;\n    &lt;groupId&gt;org.elasticsearch.client&lt;/groupId&gt;\n    &lt;artifactId&gt;elasticsearch-rest-high-level-client&lt;/artifactId&gt;\n    &lt;version&gt;${elasticsearch.version}&lt;/version&gt;\n&lt;/dependency&gt;\n</code></pre>\n\n  <p>\n    The Gradle users can declare the dependencies as\n  </p>\n<pre class=\"line-numbers  language-java\"><code>dependencies {\n    compile \"org.elasticsearch.client:elasticsearch-rest-high-level-client:${elasticsearch.version}\"\n}  </code></pre>\n\n  <p>\n    Replace the <code>${elasticsearch.version}</code> as appropriate.\n  </p>\n\n    <h2 id=\"initialization\">\n      Initialization\n    </h2>\n\n  <p>\n    The <code>RestHighLevelClient</code> is built on top of the REST low-level client builder. The following code will instantiate a low level <code>RestClientBuilder</code>.\n  </p>\n<pre class=\"line-numbers  language-java\"><code>RestClientBuilder  restClientBuilder  = RestClient.builder(\n    new HttpHost(\"localhost\", 9200, \"http\"),\n    new HttpHost(\"localhost\", 9201, \"http\"));</code></pre>\n\n  <p>\n    If the Elasticsearch is secured with user name and password then we need to provide the credentials using the&nbsp;<code>CredentialsProvider</code> as shown below. After that we can set a callback that allows to modify the http client configuration.&nbsp;\n  </p>\n<pre class=\"line-numbers  language-java\"><code>final CredentialsProvider credentialsProvider = new BasicCredentialsProvider();\ncredentialsProvider.setCredentials(AuthScope.ANY, new UsernamePasswordCredentials(\n        &lt;elasticSearchUsername&gt;, &lt;elasticSearchPassword&gt;));\nrestClientBuilder.setHttpClientConfigCallback(new HttpClientConfigCallback() {\n      @Override\n      public HttpAsyncClientBuilder customizeHttpClient(\n          HttpAsyncClientBuilder httpClientBuilder) {\n        return httpClientBuilder.setDefaultCredentialsProvider(credentialsProvider);\n      }\n    });\n/*\nUsing the Java 8 syntax, we can replace the above code like this\nbuilder.setHttpClientConfigCallback(\n        httpClientBuilder -&gt; httpClientBuilder.setDefaultCredentialsProvider(credentialsProvider));\n*/</code></pre>\n\n  <p>\n    After this we can initialize the&nbsp;<code>RestHighLevelClient</code> as follows\n  </p>\n<pre class=\"line-numbers  language-java\"><code>RestHighLevelClient client = new RestHighLevelClient(restClientBuilder);</code></pre>\n\n    <h2 id=\"usage\">\n      Usage\n    </h2>\n\n  <p>\n    Each APIs in High Level REST Client can be called synchronously or asynchronously. In case of synchronous call it returns a response object. It can throw an <code>IOException</code> if either of the following occurs:\n  </p>\n\n  <ul>\n    <li>The request times out.</li><li>The client fails to parse the REST response</li><li>There is no response coming back from the server<br></li>\n  </ul>\n<pre class=\"line-numbers  language-java\"><code>SearchRequest searchRequest = new SearchRequest(\"posts\");\nsearchRequest.source(searchSourceBuilder);\nSearchResponse searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);  \n</code></pre>\n\n  <p>\n    The following shows how to call a method asynchronously. We need to define an <code>ActionListener</code> which define how to handle the response and error if any. The following shows the code example for that:\n  </p>\n<pre class=\"line-numbers  language-java\"><code>// Asynchronous call example\nActionListener&lt;SearchResponse&gt; listener = new ActionListener&lt;SearchResponse&gt;() {\n    @Override\n    public void onResponse(SearchResponse searchResponse) {\n         //write the logic to parse the search response. \n    }\n\n    @Override\n    public void onFailure(Exception e) {\n        //Code to handle the exception goes here.\n    }\n};\nclient.searchAsync(searchRequest, RequestOptions.DEFAULT, listener);\n\n</code></pre>\n\n  <p>\n    Once we are done with the processing, the client can closed as follows:\n  </p>\n<pre class=\"line-numbers  language-java\"><code>client.close();</code></pre>\n\n  <p>\n    A working code example is present in <a href=\"https://github.com/ahmadimt/elasticsearch_samples/tree/main/high_level_rest_client\" target=\"_blank\">this git repository</a>.\n  </p>\n\n    <h2 id=\"references\">\n      References\n    </h2>\n\n  <ul>\n    <li>https://github.com/ahmadimt/elasticsearch_samples/tree/main/high_level_rest_client<br></li><li>https://www.elastic.co/blog/state-of-the-official-elasticsearch-java-clients</li><li>https://www.elastic.co/guide/en/elasticsearch/client/java-rest/master/java-rest-high.html<br></li><li>https://www.elastic.co/guide/en/elasticsearch/client/java-rest/master/java-rest-low.html<br></li><li>https://pixabay.com/illustrations/ball-round-cable-lan-connected-563972/<br></li>\n  </ul>\n<hr class=\"separator separator--dots\" />\n\n  <p>\n    The classic <code>TransportClient</code> is deprecated in Elasticsearch 7.0 and will be removed in version 8.0.\n  </p>",
            "image": "https://imteyazahmad.com/media/posts/3/ball-563972_1920.jpg",
            "author": {
                "name": "Imteyaz Ahmad"
            },
            "tags": [
                   "Java",
                   "Elasticsearch"
            ],
            "date_published": "2021-04-02T17:05:09+05:30",
            "date_modified": "2021-04-04T13:15:20+05:30"
        }
    ]
}
